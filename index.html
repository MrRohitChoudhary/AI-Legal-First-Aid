<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Legal First Aid</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.32.0"
      }
    }
    </script>
    <style>
        /* RESET & GLOBAL OVERRIDES */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #f2f4f7 !important;
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* APP CONTAINER - SCOPED STYLING */
        #legal-app {
            max-width: 900px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 40px 20px;
            background-color: #f2f4f7;
            color: #1e293b;
            box-sizing: border-box;
            position: relative; /* For absolute positioning of children */
        }

        #legal-app * {
            box-sizing: border-box;
        }

        /* TYPOGRAPHY */
        #legal-app h1, #legal-app h2, #legal-app h3 {
            font-family: 'Playfair Display', serif;
            color: #0f172a; /* Navy 900 */
        }

        #legal-app h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-align: center;
            letter-spacing: -0.02em;
        }

        #legal-app .subtitle {
            text-align: center;
            color: #64748b;
            margin-bottom: 2rem;
            font-size: 1.1rem;
            font-weight: 300;
        }

        /* EXAMPLE CHIPS */
        #legal-app .examples-section {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        #legal-app .examples-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }

        #legal-app .examples-grid {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        #legal-app .example-chip {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 0.6rem 1.2rem;
            border-radius: 24px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        #legal-app .example-chip:hover {
            border-color: #d97706;
            color: #d97706;
            background: #fffbf0;
            transform: translateY(-1px);
        }

        /* CARDS & CONTAINERS */
        #legal-app .card {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(15, 23, 42, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }

        /* INPUTS */
        #legal-app label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #334155;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #legal-app .textarea-wrapper {
            position: relative;
            width: 100%;
        }

        #legal-app textarea {
            width: 100%;
            height: 180px;
            padding: 1rem;
            padding-bottom: 3rem; /* Space for mic button */
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            color: #0f172a;
            resize: none;
            transition: all 0.2s ease;
            outline: none;
            background: #f8fafc;
        }

        #legal-app textarea:focus {
            border-color: #d97706; /* Gold 500 */
            background: #fff;
            box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.1);
        }

        /* MIC BUTTON (TEXT INPUT) */
        #legal-app .mic-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #f1f5f9;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        #legal-app .mic-btn:hover {
            background: #e2e8f0;
            color: #0f172a;
        }

        #legal-app .mic-btn.listening {
            background: #fee2e2;
            color: #ef4444;
            animation: pulse 1.5s infinite;
        }

        /* FILE UPLOAD */
        #legal-app .file-upload {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f8fafc;
            position: relative;
        }

        #legal-app .file-upload:hover {
            border-color: #d97706;
            background: #fffbf0;
        }

        #legal-app .file-upload input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        #legal-app .file-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            color: #94a3b8;
        }

        #legal-app .file-upload:hover .file-icon {
            color: #d97706;
        }

        #legal-app .file-list {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        #legal-app .file-tag {
            background: #f1f5f9;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        /* BUTTONS */
        #legal-app .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #fff;
            border: none;
            padding: 1.25rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.2);
        }

        #legal-app .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -3px rgba(15, 23, 42, 0.3);
        }

        #legal-app .btn-primary:active {
            transform: translateY(0);
        }

        #legal-app .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* RESULTS SECTION */
        #legal-app .result-box {
            display: none; /* Hidden by default */
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #legal-app .result-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
        }

        #legal-app .result-icon {
            color: #d97706;
            width: 32px;
            height: 32px;
        }

        #legal-app .content-block {
            margin-bottom: 2rem;
        }

        #legal-app .content-block h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #legal-app .content-block ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #legal-app .content-block li {
            position: relative;
            padding-left: 1.75rem;
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }

        #legal-app .content-block li::before {
            content: "‚Ä¢";
            color: #d97706;
            font-weight: bold;
            position: absolute;
            left: 0;
            font-size: 1.2rem;
            top: -2px;
        }

        /* LOADING OVERLAY */
        #legal-app .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #legal-app .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        #legal-app .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #d97706;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        /* FOOTER */
        #legal-app .footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
            color: #94a3b8;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        #legal-app .disclaimer {
            background: #fffbf0;
            border: 1px solid #fde68a;
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 2rem;
            font-size: 0.9rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        /* --- LIVE ASSISTANT STYLES --- */
        #legal-app .live-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: #d97706;
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(217, 119, 6, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
        }

        #legal-app .live-fab:hover {
            transform: scale(1.1);
            background: #b45309;
        }

        #legal-app .live-fab svg {
            width: 28px;
            height: 28px;
        }

        #legal-app .live-interface {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 360px;
            height: 520px;
            background: #0f172a;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden;
            z-index: 2001;
            transform-origin: bottom right;
            animation: expandLive 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #legal-app .live-header {
            padding: 1rem;
            background: rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 2;
        }

        #legal-app .live-video-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        #legal-app #liveVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
        }
        
        #legal-app .voice-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            z-index: 3;
        }

        #legal-app .voice-bar {
            width: 0%;
            height: 100%;
            background: #d97706;
            transition: width 0.1s ease;
            margin: 0 auto;
        }

        #legal-app .live-controls {
            padding: 1.5rem;
            background: #1e293b;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        #legal-app .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #334155;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        #legal-app .control-btn.active {
            background: #fff;
            color: #0f172a;
        }

        #legal-app .control-btn.end-call {
            background: #ef4444;
            color: white;
        }

        #legal-app .control-btn.end-call:hover {
            background: #dc2626;
        }

        /* ANIMATIONS */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes expandLive { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

<div id="legal-app">
    <!-- Header -->
    <header>
        <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
            <svg class="result-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
            </svg>
        </div>
        <h1>AI Legal First Aid</h1>
        <p class="subtitle">Rights Awareness & Immediate Next Steps</p>
    </header>

    <!-- Example Prompts -->
    <div class="examples-section">
        <p class="examples-label">Try an example scenario:</p>
        <div class="examples-grid">
            <button class="example-chip" onclick="useExample(1)">
                <span>üöó</span> Traffic Accident
            </button>
            <button class="example-chip" onclick="useExample(2)">
                <span>üè†</span> Landlord Dispute
            </button>
            <button class="example-chip" onclick="useExample(3)">
                <span>üì¶</span> Defective Product
            </button>
        </div>
    </div>

    <!-- Input Section -->
    <div class="card">
        <label for="situation">Describe the Situation</label>
        <div class="textarea-wrapper">
            <textarea id="situationInput" placeholder="Describe what happened, who is involved, and what you need help with..."></textarea>
            <button id="micBtn" class="mic-btn" title="Speak">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
        </div>
        
        <div style="margin-top: 1.5rem;">
            <label>Evidence (Optional)</label>
            <div class="file-upload" id="dropZone">
                <input type="file" id="fileInput" multiple accept="image/*,application/pdf,text/*">
                <svg class="file-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p style="margin: 0; color: #64748b; font-weight: 500;">Click to upload or drag files here</p>
                <p style="margin: 0.25rem 0 0; color: #94a3b8; font-size: 0.85rem;">Images, PDF, Text</p>
            </div>
            <div id="fileList" class="file-list"></div>
        </div>

        <div style="margin-top: 2rem;">
            <button id="analyzeBtn" class="btn-primary">
                Analyze My Situation
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" style="width: 20px;">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultBox" class="card result-box">
        <div class="result-header">
            <svg class="result-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 style="margin: 0; font-size: 1.5rem;">Assessment</h2>
        </div>
        
        <div class="content-block">
            <h3 style="color: #0f172a;">Summary</h3>
            <p id="resSummary" style="color: #475569; line-height: 1.7;"></p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
            <div class="content-block">
                <h3 style="color: #b45309;">
                    <svg xmlns="http://www.w3.org/2000/svg" style="width: 20px;" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg>
                    Potential Rights
                </h3>
                <ul id="resRights"></ul>
            </div>

            <div class="content-block">
                <h3 style="color: #059669;">
                    <svg xmlns="http://www.w3.org/2000/svg" style="width: 20px;" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                    Recommended Actions
                </h3>
                <ul id="resSteps"></ul>
            </div>
        </div>

        <div class="disclaimer">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; min-width: 24px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span id="resDisclaimer"></span>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>¬© 2024 AI Legal First Aid. Powered by Gemini.</p>
        <p><strong>Disclaimer:</strong> This tool provides general legal information only. It is NOT legal advice and does not create an attorney-client relationship. Always consult a qualified lawyer for your specific situation.</p>
    </footer>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <h3 style="color: #0f172a;">Analyzing Situation...</h3>
        <p style="color: #64748b;">Consulting legal knowledge base</p>
    </div>

    <!-- Live Assistant FAB -->
    <button id="liveFab" class="live-fab" title="Start Live Consultation">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M4.5 4.5a3 3 0 00-3 3v9a3 3 0 003 3h8.25a3 3 0 003-3v-9a3 3 0 00-3-3H4.5zM19.94 18.75l-2.69-2.69V7.94l2.69-2.69c.944-.945 2.56-.276 2.56 1.06v11.38c0 1.336-1.616 2.005-2.56 1.06z" />
        </svg>
    </button>

    <!-- Live Assistant Interface -->
    <div id="liveInterface" class="live-interface">
        <div class="live-header">
            <span style="font-weight: 600; font-size: 0.9rem;">Live Legal Assistant</span>
            <div style="display:flex; align-items:center; gap:0.5rem;">
                 <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></span>
                 <span style="font-size: 0.75rem;">Online</span>
            </div>
        </div>
        <div class="live-video-container">
            <video id="liveVideo" autoplay playsinline muted></video>
            <canvas id="videoCanvas" style="display:none;"></canvas>
            <div class="voice-indicator">
                <div id="voiceBar" class="voice-bar"></div>
            </div>
        </div>
        <div class="live-controls">
             <button id="toggleMicBtn" class="control-btn active" title="Mute/Unmute">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                 </svg>
             </button>
             <button id="endLiveBtn" class="control-btn end-call" title="End Call">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                 </svg>
             </button>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenAI, Modality } from "@google/genai";

    const state = {
        files: [],
        isLoading: false,
        isListening: false,
        liveSession: null,
        audioContext: null,
        inputSource: null,
        processor: null,
        videoInterval: null,
        nextStartTime: 0
    };

    // DOM Elements
    const els = {
        input: document.getElementById('situationInput'),
        micBtn: document.getElementById('micBtn'),
        fileInput: document.getElementById('fileInput'),
        fileList: document.getElementById('fileList'),
        analyzeBtn: document.getElementById('analyzeBtn'),
        loading: document.getElementById('loadingOverlay'),
        resultBox: document.getElementById('resultBox'),
        summary: document.getElementById('resSummary'),
        rights: document.getElementById('resRights'),
        steps: document.getElementById('resSteps'),
        disclaimer: document.getElementById('resDisclaimer'),
        // Live UI
        liveFab: document.getElementById('liveFab'),
        liveInterface: document.getElementById('liveInterface'),
        liveVideo: document.getElementById('liveVideo'),
        videoCanvas: document.getElementById('videoCanvas'),
        toggleMicBtn: document.getElementById('toggleMicBtn'),
        endLiveBtn: document.getElementById('endLiveBtn'),
        voiceBar: document.getElementById('voiceBar')
    };

    // --- Example Prompts ---
    const examples = {
        1: "I was hit by a car while crossing the street at a green light. The driver was speeding and refused to stop. I have minor injuries and a broken phone.",
        2: "My landlord is refusing to return my security deposit of ‚Çπ20,000, claiming 'painting charges' even though I left the apartment in good condition.",
        3: "I bought a refrigerator online 2 weeks ago. It stopped cooling yesterday. The seller says 'no returns' even though it's under warranty."
    };

    window.useExample = (id) => {
        els.input.value = examples[id];
        els.input.focus();
    };

    // --- Standard Voice Input (Text Area) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-IN';
        recognition.interimResults = false;

        recognition.onstart = () => {
            state.isListening = true;
            els.micBtn.classList.add('listening');
        };

        recognition.onend = () => {
            state.isListening = false;
            els.micBtn.classList.remove('listening');
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            const currentText = els.input.value;
            els.input.value = currentText + (currentText.length > 0 ? ' ' : '') + transcript;
        };

        els.micBtn.addEventListener('click', () => {
            if (state.isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });
    } else {
        els.micBtn.style.display = 'none';
    }


    // --- File Handling ---
    els.fileInput.addEventListener('change', async (e) => {
        const newFiles = Array.from(e.target.files);
        for (const file of newFiles) {
            const base64 = await readFileAsBase64(file);
            state.files.push({ file, base64 });
        }
        renderFiles();
    });

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function renderFiles() {
        els.fileList.innerHTML = '';
        state.files.forEach((item, idx) => {
            const tag = document.createElement('div');
            tag.className = 'file-tag';
            tag.innerHTML = `
                <span>${item.file.name}</span>
                <span style="cursor:pointer; color:#ef4444; font-weight:bold;" onclick="removeFile(${idx})">√ó</span>
            `;
            els.fileList.appendChild(tag);
        });
    }

    window.removeFile = (idx) => {
        state.files.splice(idx, 1);
        renderFiles();
    };

    // --- Text Analysis Integration ---
    els.analyzeBtn.addEventListener('click', async () => {
        const text = els.input.value.trim();
        if (!text && state.files.length === 0) {
            alert('Please describe your situation or upload a document.');
            return;
        }

        setLoading(true);

        try {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            
            const parts = [];
            if (text) parts.push({ text });
            state.files.forEach(f => {
                parts.push({
                    inlineData: {
                        mimeType: f.file.type,
                        data: f.base64
                    }
                });
            });

            const systemInstruction = `
            You are an AI Legal First Aid assistant. 
            ROLE: Provide legal awareness, identify potential rights, and suggest immediate next steps.
            JURISDICTION: Assume India unless context implies otherwise.
            TONE: Professional, objective, calm, and empathetic.
            CONSTRAINT: NEVER provide legal advice. Always end with a disclaimer.
            OUTPUT FORMAT: JSON with keys: 'summary', 'rights' (array), 'steps' (array), 'disclaimer'.
            `;

            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: { parts },
                config: {
                    systemInstruction: systemInstruction,
                    responseMimeType: "application/json"
                }
            });

            if (response.text) {
                const data = JSON.parse(response.text);
                renderResults(data);
            }

        } catch (error) {
            console.error(error);
            alert('Analysis failed. Please try again.');
        } finally {
            setLoading(false);
        }
    });

    function setLoading(loading) {
        state.isLoading = loading;
        if (loading) {
            els.loading.classList.add('active');
            els.analyzeBtn.disabled = true;
        } else {
            els.loading.classList.remove('active');
            els.analyzeBtn.disabled = false;
        }
    }

    function renderResults(data) {
        els.summary.textContent = data.summary;
        
        els.rights.innerHTML = data.rights.map(r => `<li>${r}</li>`).join('');
        els.steps.innerHTML = data.steps.map(s => `<li>${s}</li>`).join('');
        els.disclaimer.textContent = data.disclaimer;

        els.resultBox.style.display = 'block';
        els.resultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }


    // --- REALTIME LIVE API LOGIC ---
    
    // Audio Conversion Helpers
    function float32ToPCM16(float32Arr) {
        const pcm16 = new Int16Array(float32Arr.length);
        for (let i = 0; i < float32Arr.length; i++) {
            let s = Math.max(-1, Math.min(1, float32Arr[i]));
            pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return pcm16;
    }

    function base64Encode(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    function decodeAudioData(base64, ctx) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        const dataInt16 = new Int16Array(bytes.buffer);
        // Output audio is 24kHz
        const buffer = ctx.createBuffer(1, dataInt16.length, 24000); 
        const channelData = buffer.getChannelData(0);
        for (let i = 0; i < dataInt16.length; i++) {
            channelData[i] = dataInt16[i] / 32768.0;
        }
        return buffer;
    }

    async function startLiveSession() {
        try {
            els.liveFab.style.display = 'none';
            els.liveInterface.style.display = 'flex';
            
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            
            // Audio Contexts
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            state.audioContext = new AudioContext({ sampleRate: 16000 }); // Input req 16k
            const outputCtx = new AudioContext({ sampleRate: 24000 }); // Output req 24k
            state.nextStartTime = outputCtx.currentTime;

            // Media Stream (Mic + Camera)
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
            els.liveVideo.srcObject = stream;

            // Connect to Gemini Live
            const sessionPromise = ai.live.connect({
                model: 'gemini-2.5-flash-native-audio-preview-09-2025',
                callbacks: {
                    onopen: () => {
                        console.log('Live Session Connected');
                        
                        // Setup Audio Input Processing
                        state.inputSource = state.audioContext.createMediaStreamSource(stream);
                        state.processor = state.audioContext.createScriptProcessor(4096, 1, 1);
                        
                        state.processor.onaudioprocess = (e) => {
                            const inputData = e.inputBuffer.getChannelData(0);
                            const pcm16 = float32ToPCM16(inputData);
                            const base64Audio = base64Encode(pcm16.buffer);
                            
                            sessionPromise.then(session => {
                                session.sendRealtimeInput({
                                    media: {
                                        mimeType: 'audio/pcm;rate=16000',
                                        data: base64Audio
                                    }
                                });
                            });
                            
                            // Visualizer update
                            const vol = Math.abs(inputData[0]) * 100;
                            els.voiceBar.style.width = Math.min(100, vol * 5) + '%';
                        };

                        state.inputSource.connect(state.processor);
                        state.processor.connect(state.audioContext.destination);

                        // Setup Video Input Processing (1 FPS)
                        state.videoInterval = setInterval(() => {
                            const ctx = els.videoCanvas.getContext('2d');
                            els.videoCanvas.width = els.liveVideo.videoWidth;
                            els.videoCanvas.height = els.liveVideo.videoHeight;
                            ctx.drawImage(els.liveVideo, 0, 0);
                            
                            const base64Img = els.videoCanvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                            sessionPromise.then(session => {
                                session.sendRealtimeInput({
                                    media: {
                                        mimeType: 'image/jpeg',
                                        data: base64Img
                                    }
                                });
                            });
                        }, 1000);
                    },
                    onmessage: (msg) => {
                        // Handle Audio Output
                        const audioData = msg.serverContent?.modelTurn?.parts?.[0]?.inlineData?.data;
                        if (audioData) {
                             const buffer = decodeAudioData(audioData, outputCtx);
                             const source = outputCtx.createBufferSource();
                             source.buffer = buffer;
                             source.connect(outputCtx.destination);
                             
                             // Gapless playback logic
                             const startTime = Math.max(outputCtx.currentTime, state.nextStartTime);
                             source.start(startTime);
                             state.nextStartTime = startTime + buffer.duration;
                        }
                    },
                    onclose: () => {
                        console.log('Live Session Closed');
                        stopLiveSession();
                    },
                    onerror: (err) => {
                        console.error('Live Error:', err);
                        stopLiveSession();
                    }
                },
                config: {
                    responseModalities: [Modality.AUDIO],
                    systemInstruction: "You are a helpful, professional legal assistant. You are seeing the user via video and hearing them. Answer briefly and helpfully about legal situations. Do not give legal advice, only awareness.",
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Kore' } }
                    }
                }
            });
            
            state.liveSession = sessionPromise;

        } catch (err) {
            console.error(err);
            alert('Could not start live session. Please allow camera/microphone access.');
            stopLiveSession();
        }
    }

    function stopLiveSession() {
        if (state.processor) {
            state.processor.disconnect();
            state.processor.onaudioprocess = null;
        }
        if (state.inputSource) state.inputSource.disconnect();
        if (state.audioContext) state.audioContext.close();
        if (state.videoInterval) clearInterval(state.videoInterval);
        
        // Stop Media Tracks
        if (els.liveVideo.srcObject) {
            els.liveVideo.srcObject.getTracks().forEach(track => track.stop());
            els.liveVideo.srcObject = null;
        }

        els.liveInterface.style.display = 'none';
        els.liveFab.style.display = 'flex';
    }

    // Live Controls
    els.liveFab.addEventListener('click', startLiveSession);
    
    els.endLiveBtn.addEventListener('click', () => {
        // We can't explicitly close the session object easily in the SDK wrapper without keeping ref to close() method 
        // if it exposed it, but closing the view and stopping tracks effectively ends our side.
        // Re-connecting will create a new session.
        stopLiveSession();
    });

    els.toggleMicBtn.addEventListener('click', () => {
        const tracks = els.liveVideo.srcObject?.getAudioTracks();
        if (tracks && tracks.length > 0) {
            const enabled = !tracks[0].enabled;
            tracks[0].enabled = enabled;
            els.toggleMicBtn.classList.toggle('active', enabled);
            els.toggleMicBtn.innerHTML = enabled ? 
                `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>` : 
                `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>`;
        }
    });

</script>
</body>
</html>